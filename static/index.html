<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Analysis RAG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        .chat-container {
            height: 500px; /* Fixed height instead of viewport-based */
            max-height: 600px;
        }
        .messages {
            height: calc(100% - 60px);
            overflow-y: auto;
        }
        .document-item {
            word-break: break-word;
            overflow-wrap: break-word;
        }
        .document-filename {
            font-weight: 600;
            font-size: 0.875rem;
            line-height: 1.25rem;
            word-break: break-word;
            overflow-wrap: break-word;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .session-item {
            transition: all 0.2s ease;
        }

        .session-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .session-current {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
        }

        .btn-primary {
            @apply px-3 py-2 bg-blue-500 text-white rounded-md text-sm font-medium hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-all duration-200 shadow-sm;
        }

        .btn-success {
            @apply px-3 py-2 bg-green-500 text-white rounded-md text-sm font-medium hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 transition-all duration-200 shadow-sm;
        }

        .btn-warning {
            @apply px-3 py-2 bg-amber-500 text-white rounded-md text-sm font-medium hover:bg-amber-600 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-opacity-50 transition-all duration-200 shadow-sm;
        }

        .btn-danger {
            @apply px-4 py-2 bg-red-500 text-white rounded-md text-sm font-medium hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 transition-all duration-200 shadow-sm;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto p-4 max-w-6xl">
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Document Analysis RAG</h1>
            <p class="text-gray-600 mb-4">Upload documents and chat with them using Llama 3.1:8b</p>
            <div class="bg-blue-50 border-l-4 border-blue-400 p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-blue-700">
                            <strong>Quick Start:</strong> Click "Test Upload" to try the system with a sample document, or select your own files above.
                            <br><strong>Note:</strong> If documents don't appear after upload, click the "üîÑ Refresh" button next to "Uploaded Documents".
                        </p>
                    </div>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-4 gap-6">
            <!-- Document Upload Section -->
            <div class="lg:col-span-1 xl:col-span-1">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4">Upload Documents</h2>
                    
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                        <input type="file" id="fileInput" multiple accept=".pdf,.txt,.csv,.xlsx,.docx,.md,.json" class="hidden">
                        <label for="fileInput" class="cursor-pointer">
                            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                            </svg>
                            <p class="mt-2 text-sm text-gray-600">Click to upload or drag and drop</p>
                            <p class="text-xs text-gray-500">PDF, TXT, CSV, Excel, Word, Markdown, JSON</p>
                            <p id="fileStatus" class="mt-2 text-xs text-blue-600 hidden">Files selected - uploading...</p>
                        </label>
                        <div class="mt-4 space-y-2">
                            <button onclick="(async () => { console.log('üîò Upload Selected Files button clicked'); try { await handleFileUpload(); } catch(e) { console.error('Upload failed:', e); } })()" class="btn-secondary px-4">
                                Upload Selected Files
                            </button>
                            <button onclick="(async () => { console.log('üîò Test Upload button clicked'); try { await testUpload(); } catch(e) { console.error('Test upload failed:', e); } })()" class="btn-primary px-4">
                                Test Upload (creates sample file)
                            </button>
                            <p class="text-xs text-gray-500">Or select files above to upload your own documents</p>
                        </div>
                    </div>
                    
                    <div id="uploadProgress" class="hidden mt-4">
                        <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4">
                            <p class="font-bold">Uploading...</p>
                            <div class="loading"></div>
                        </div>
                    </div>
                    
                    <div id="uploadResults" class="mt-4 space-y-2"></div>
                </div>

                <!-- Document List -->
                <div class="bg-white rounded-lg shadow-md p-6 mt-6">
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <h2 class="text-xl font-semibold">Uploaded Documents</h2>
                             <button onclick="(async () => { console.log('üîò Refresh button clicked'); try { await refreshDocuments(); } catch(e) { console.error('Refresh failed:', e); } })()" id="refreshBtn" class="btn-primary disabled:opacity-50 px-3 py-2">
                                 üîÑ Refresh
                             </button>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="(async () => { console.log('üîò New Session button clicked'); try { await startNewSession(); } catch(e) { console.error('New session failed:', e); } })()" class="btn-success px-4 py-2 font-medium">
                                üÜï New Session
                            </button>
                            <button onclick="(async () => { console.log('üîò Clear Sessions button clicked'); try { await clearAllSessions(); } catch(e) { console.error('Clear sessions failed:', e); } })()" class="btn-warning px-4 py-2 font-medium">
                                üßπ Clear Sessions
                            </button>
                        </div>
                    </div>
                    <div id="documentList" class="space-y-2">
                        <p class="text-gray-500 text-sm">Loading documents...</p>
                    </div>
                </div>

                <!-- Sessions List -->
                <div class="bg-white rounded-lg shadow-md p-6 mt-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Chat Sessions</h2>
                         <button onclick="(async () => { console.log('üîò Sessions refresh clicked'); try { await loadSessions(); } catch(e) { console.error('Load sessions failed:', e); } })()" class="btn-primary text-xs px-2 py-1">
                             üîÑ Refresh
                         </button>
                    </div>
                    <div id="sessionsList" class="space-y-2 max-h-96 overflow-y-auto">
                        <p class="text-gray-500 text-sm">Loading sessions...</p>
                    </div>
                </div>
            </div>

            <!-- Chat Section -->
            <div class="lg:col-span-1 xl:col-span-2">
                <div class="bg-white rounded-lg shadow-md p-6 h-full flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Chat with Documents</h2>
                        <label class="flex items-center space-x-2 text-sm">
                            <input type="checkbox" id="webSearchToggle" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="text-gray-700">üåê Include web search</span>
                        </label>
                    </div>
                    
                    <div class="chat-container flex flex-col">
                        <div id="messages" class="messages bg-gray-50 rounded-lg p-4 mb-4">
                            <div class="text-center text-gray-500 py-8">
                                <p>Upload documents and start chatting!</p>
                            </div>
                        </div>
                        
                        <div class="flex gap-2">
                             <input
                                 type="text"
                                 id="messageInput"
                                 placeholder="Ask about your documents..."
                                 class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                 onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"
                             >
                            <button
                                onclick="(async () => { console.log('üîò Send button clicked'); try { await sendMessage(); } catch(e) { console.error('Send message failed:', e); } })()"
                                type="button"
                                id="sendButton"
                                class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 transition-all duration-200"
                            >
                                Send
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Stats -->
        <div class="mt-6 bg-white rounded-lg shadow-md p-6">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 mb-4">
                <h2 class="text-xl font-semibold">System Statistics</h2>
                <button onclick="(async () => { console.log('üîò Delete all clicked'); try { await deleteAllDocuments(); } catch(e) { console.error('Delete all failed:', e); } })()" id="deleteAllBtn"
                        class="btn-danger disabled:opacity-50 self-start sm:self-auto">
                    üóëÔ∏è Delete All Documents
                </button>
            </div>
            <div id="systemStats" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="text-center">
                    <div class="text-2xl font-bold text-blue-600" id="docCount">0</div>
                    <div class="text-gray-600">Documents</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-600" id="sessionCount">0</div>
                    <div class="text-gray-600">Chat Sessions</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-purple-600" id="modelInfo">Llama 3.1:8b</div>
                    <div class="text-gray-600">Model</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('üé¨ Script loaded successfully');

        // Test basic functionality
        try {
            console.log('üß™ Testing basic DOM access...');
            const testDiv = document.createElement('div');
            testDiv.textContent = 'Test';
            console.log('‚úÖ DOM manipulation works');

            console.log('üß™ Testing fetch API...');
            // Just test that fetch exists
            if (typeof fetch === 'function') {
                console.log('‚úÖ Fetch API available');
            } else {
                console.error('‚ùå Fetch API not available');
            }

        } catch (error) {
            console.error('‚ùå Basic functionality test failed:', error);
        }

        let sessionId = null;
        let documents = [];
        console.log('üìä Initial variables set:', {sessionId, documentsLength: documents.length});

        // Function definitions
        async function handleFileUpload() {
            console.log('üéØ handleFileUpload triggered!');
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;

            console.log('üìÅ Files selected:', files);
            console.log('üìä Number of files:', files.length);

            if (files.length === 0) {
                console.log('No files selected, returning');
                alert('Please select at least one file to upload.');
                return;
            }

            const progressDiv = document.getElementById('uploadProgress');
            const resultsDiv = document.getElementById('uploadResults');

            console.log('Showing progress div');
            progressDiv.classList.remove('hidden');

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                console.log(`Processing file ${i + 1}/${files.length}:`, file.name, 'size:', file.size);

                const formData = new FormData();
                formData.append('file', file);

                try {
                    console.log('Sending upload request for:', file.name);

                    const response = await fetch('/api/v1/upload', {
                        method: 'POST',
                        body: formData
                    });

                    console.log('Response received, status:', response.status);

                    if (!response.ok) {
                        let errorText;
                        try {
                            errorText = await response.text();
                            console.error('Error response body:', errorText);
                        } catch (e) {
                            errorText = `HTTP ${response.status}: ${response.statusText}`;
                        }
                        console.error('Upload failed with status:', response.status);
                        showUploadResult({message: `Upload failed: ${response.status} ${response.statusText}\n${errorText}`}, false);
                        continue;
                    }

                    let result;
                    try {
                        result = await response.json();
                        console.log('Upload successful, result:', result);
                    } catch (e) {
                        console.error('Failed to parse JSON response');
                        const textResponse = await response.text();
                        console.log('Raw response text:', textResponse);
                        showUploadResult({message: 'Server returned invalid response format'}, false);
                        continue;
                    }

                    if (result && result.success) {
                        documents.push(result);
                        showUploadResult(result, true);
                        console.log('File uploaded successfully:', result.filename);
                        console.log('üîÑ Refreshing document list...');
                        // Refresh the document list to show the new document
                        await loadDocuments();
                        console.log('‚úÖ Document list refreshed');
                    } else {
                        console.error('Upload result indicates failure:', result);
                        showUploadResult(result || {message: 'Unknown upload error'}, false);
                    }
                } catch (error) {
                    console.error('Network error during upload:', error);
                    showUploadResult({message: `Network error: ${error.message}`}, false);
                }
            }

            progressDiv.classList.add('hidden');
            document.getElementById('fileStatus').classList.add('hidden');
            fileInput.value = '';
            loadDocuments();
            loadStats();
        }

        function addResult(message, isSuccess = true) {
            const resultsDiv = document.getElementById('uploadResults');
            const div = document.createElement('div');

            console.log('Adding result:', message, 'success:', isSuccess);

            if (isSuccess) {
                div.className = 'bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-3 mt-2';
            } else {
                div.className = 'bg-red-100 border-l-4 border-red-500 text-red-700 p-3 mt-2';
            }

            div.innerHTML = `<p class="text-sm">${message}</p>`;
            resultsDiv.appendChild(div);

            // Remove after 8 seconds
            setTimeout(() => {
                if (div.parentNode) {
                    div.remove();
                }
            }, 8000);
        }

        function showUploadResult(result, success) {
            const resultsDiv = document.getElementById('uploadResults');
            const div = document.createElement('div');

            console.log('Showing upload result:', result, 'success:', success);

            if (!result) {
                result = { message: 'Unknown error occurred' };
            }

            if (success) {
                div.className = 'bg-green-100 border-l-4 border-green-500 text-green-700 p-3';
                div.innerHTML = `
                    <p class="font-bold">‚úì ${result.filename || result.document_id || 'File'}</p>
                    <p class="text-sm">${result.message || 'Upload successful'}</p>
                `;
            } else {
                div.className = 'bg-red-100 border-l-4 border-red-500 text-red-700 p-3';
                div.innerHTML = `
                    <p class="font-bold">‚úó Upload Failed</p>
                    <p class="text-sm">${result.message || 'Unknown error'}</p>
                `;
            }

            resultsDiv.appendChild(div);

            // Remove after 10 seconds for errors, 5 for success
            setTimeout(() => {
                if (div.parentNode) {
                    div.remove();
                }
            }, success ? 5000 : 10000);
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message) return;

            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = true;
            sendButton.innerHTML = '<div class="loading"></div>';

            // Add user message to chat
            console.log('üí¨ Adding user message:', message);
            addMessage('user', message);
            input.value = '';
            console.log('‚úÖ User message added to chat');

            try {
                const includeWebSearch = document.getElementById('webSearchToggle').checked;

                const response = await fetch('/api/v1/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        session_id: sessionId,
                        include_web_search: includeWebSearch
                    })
                });

                const result = await response.json();
                sessionId = result.session_id;

                // Add AI response to chat
                addMessage('assistant', result.response, result.sources);

                // Refresh sessions list to show updated message count
                await loadSessions();

            } catch (error) {
                addMessage('assistant', 'Sorry, I encountered an error. Please try again.');
            } finally {
                sendButton.disabled = false;
                sendButton.textContent = 'Send';
            }
        }

        function addMessage(role, content, sources = null) {
            console.log('üìù addMessage called with role:', role, 'content length:', content.length);
            const messagesDiv = document.getElementById('messages');
            console.log('üéØ messages div found:', !!messagesDiv);

            if (!messagesDiv) {
                console.error('‚ùå messages div not found! Cannot add message.');
                return;
            }

            // Remove initial message if present
            const initial = messagesDiv.querySelector('.text-center');
            if (initial) {
                console.log('üóëÔ∏è Removing initial message');
                initial.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `mb-4 ${role === 'user' ? 'text-right' : 'text-left'}`;

            const bubble = document.createElement('div');
            bubble.className = `inline-block max-w-xs lg:max-w-md px-4 py-2 rounded-lg relative ${
                role === 'user'
                    ? 'bg-blue-600 text-white'
                    : 'bg-gray-200 text-gray-800'
            }`;
            bubble.textContent = content;

            // Add copy button
            const copyBtn = document.createElement('button');
            copyBtn.className = 'absolute top-1 right-1 text-xs opacity-50 hover:opacity-100 transition-opacity';
            copyBtn.textContent = 'üìã';
            copyBtn.title = 'Copy message';
            copyBtn.onclick = () => {
                navigator.clipboard.writeText(content).then(() => {
                    copyBtn.textContent = '‚úÖ';
                    setTimeout(() => copyBtn.textContent = 'üìã', 1000);
                }).catch(err => console.error('Copy failed:', err));
            };
            bubble.appendChild(copyBtn);

            messageDiv.appendChild(bubble);

            // Add sources if available
            if (sources && sources.length > 0) {
                try {
                    const sourcesDiv = document.createElement('div');
                    sourcesDiv.className = 'mt-2 text-xs text-gray-600';
                    const sourcesHtml = `
                        <details>
                            <summary class="cursor-pointer font-semibold">Sources (${sources.length})</summary>
                            <div class="mt-2 space-y-1">
                                ${sources.map(source => {
                                    if (source.type === 'web') {
                                        return `
                                            <div class="bg-blue-50 p-2 rounded border border-blue-200">
                                                <div class="font-semibold text-blue-800">üåê ${source.title || 'Web Result'}</div>
                                                <div class="text-gray-600 text-xs">${source.source || 'Web'}</div>
                                                <div class="text-gray-500">${source.content.substring(0, 100)}${source.content.length > 100 ? '...' : ''}</div>
                                            </div>
                                        `;
                                    }
                                }).join('')}
                            </div>
                        </details>
                    `;
                    sourcesDiv.innerHTML = sourcesHtml;
                    messageDiv.appendChild(sourcesDiv);
                    console.log('‚úÖ Sources added to message');
                } catch (sourcesError) {
                    console.error('‚ùå Error adding sources to message:', sourcesError);
                }
            }

            try {
                messagesDiv.appendChild(messageDiv);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
                console.log('‚úÖ Message added to chat successfully');
            } catch (appendError) {
                console.error('‚ùå Error appending message to DOM:', appendError);
            }
        }

        async function loadSessions() {
            console.log('üìã Loading chat sessions...');

            try {
                const response = await fetch('/api/v1/sessions');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('üìã Loaded sessions:', data.sessions.length, 'sessions');

                const sessionsDiv = document.getElementById('sessionsList');

                if (data.sessions.length === 0) {
                    sessionsDiv.innerHTML = '<p class="text-gray-500 text-sm">No chat sessions yet</p>';
                    return;
                }

                // Sort sessions by last access (most recent first)
                data.sessions.sort((a, b) => b.last_access - a.last_access);

                sessionsDiv.innerHTML = data.sessions.map(session => {
                    const isCurrentSession = session.id === sessionId;
                    const lastMessage = session.last_message || 'No messages yet';
                    const messageCount = session.message_count;
                    const sessionName = session.name || 'Chat Session';

                    return `
                        <div class="session-item bg-gray-50 p-3 rounded border cursor-pointer ${isCurrentSession ? 'session-current' : 'hover:bg-gray-100'}"
                             onclick="switchToSession('${session.id}')">
                            <div class="flex justify-between items-start mb-1">
                                <div class="font-medium text-sm text-gray-800 truncate flex-1" title="${sessionName}">
                                    ${sessionName}
                                </div>
                                <div class="flex items-center gap-2 ml-2">
                                    <div class="text-xs text-gray-500 flex items-center">
                                        <span class="mr-1">üí¨</span>
                                        ${messageCount}
                                    </div>
                                    <button onclick="event.stopPropagation(); deleteSession('${session.id}')" class="px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600" title="Delete session">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </div>
                            <div class="text-xs text-gray-600 truncate" title="${lastMessage}">
                                ${lastMessage || 'Empty session'}
                            </div>
                            <div class="text-xs text-gray-400 mt-1">
                                ${new Date(session.last_access * 1000).toLocaleDateString()}
                            </div>
                            ${isCurrentSession ? '<div class="text-xs text-blue-600 mt-1 font-medium">‚óè Active</div>' : ''}
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('‚ùå Error loading sessions:', error);
                const sessionsDiv = document.getElementById('sessionsList');
                sessionsDiv.innerHTML = '<p class="text-red-500 text-sm">Error loading sessions</p>';
            }
        }

        async function switchToSession(newSessionId) {
            console.log('üîÑ Switching to session:', newSessionId);

            // Update current session
            sessionId = newSessionId;

            // Load chat history for this session
            await loadChatHistory(newSessionId);

            // Refresh sessions list to show current session
            await loadSessions();

            addResult(`üîÑ Switched to session: ${newSessionId}`);
        }

        async function loadChatHistory(sessionId) {
            console.log('üìñ Loading chat history for session:', sessionId);

            try {
                const response = await fetch(`/api/v1/chat/history/${sessionId}`);
                if (!response.ok) {
                    if (response.status === 404) {
                        // Session not found, start fresh
                        const messagesDiv = document.getElementById('messages');
                        messagesDiv.innerHTML = `
                            <div class="text-center text-gray-500 py-8">
                                <p>üÜï New chat session started!</p>
                                <p class="mt-2">Ask questions about your uploaded documents.</p>
                            </div>
                        `;
                        return;
                    }
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                const history = data.history || [];

                const messagesDiv = document.getElementById('messages');

                if (history.length === 0) {
                    messagesDiv.innerHTML = `
                        <div class="text-center text-gray-500 py-8">
                            <p>üÜï New chat session started!</p>
                            <p class="mt-2">Ask questions about your uploaded documents.</p>
                        </div>
                    `;
                    return;
                }

                // Display chat history
                messagesDiv.innerHTML = history.map(msg => {
                    const isUser = msg.role === 'human';
                    return `
                        <div class="mb-4 ${isUser ? 'text-right' : 'text-left'}">
                            <div class="inline-block max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${
                                isUser
                                    ? 'bg-blue-500 text-white'
                                    : 'bg-gray-200 text-gray-800'
                            }">
                                <p class="text-sm">${msg.content}</p>
                            </div>
                        </div>
                    `;
                }).join('');

                // Scroll to bottom
                messagesDiv.scrollTop = messagesDiv.scrollHeight;

            } catch (error) {
                console.error('‚ùå Error loading chat history:', error);
                const messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML = `
                    <div class="text-center text-red-500 py-8">
                        <p>‚ùå Error loading chat history</p>
                        <p class="mt-2 text-sm">${error.message}</p>
                    </div>
                `;
            }
        }

        async function loadDocuments() {
            console.log('üîÑ loadDocuments() called - Loading documents...');
            try {
                console.log('üåê Fetching from /api/v1/documents...');
                const response = await fetch('/api/v1/documents');
                console.log('üì° Documents API response status:', response.status, 'ok:', response.ok);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                if (!response.ok) {
                    console.error('‚ùå Failed to fetch documents:', response.status, response.statusText);
                    const listDiv = document.getElementById('documentList');
                    listDiv.innerHTML = '<p class="text-red-500 text-sm">Error loading documents</p>';
                    return;
                }

                const docs = await response.json();
                console.log('üìÑ Loaded documents:', docs.length, 'documents');
                console.log('üìã Document data:', docs);

                const listDiv = document.getElementById('documentList');
                console.log('üéØ documentList element found:', !!listDiv);

                if (!listDiv) {
                    throw new Error('documentList element not found in DOM');
                }

                if (docs.length === 0) {
                    console.log('üì≠ No documents found, showing empty message');
                    listDiv.innerHTML = '<p class="text-gray-500 text-sm">No documents uploaded yet</p>';
                    return;
                }

                console.log('üìù Rendering', docs.length, 'documents...');

                try {
                    const htmlContent = docs.map(doc => `
                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 document-item shadow-sm">
                        <div class="document-filename text-gray-800 font-medium" title="${doc.metadata.filename}">${doc.metadata.filename}</div>
                        <div class="text-xs text-gray-500 mt-1 mb-3">
                            ${doc.metadata.file_type.toUpperCase()} ‚Ä¢ ${formatBytes(doc.metadata.file_size)} ‚Ä¢ ${doc.chunk_count} chunks
                        </div>
                        <div class="border-t border-gray-200 pt-3">
                            <div class="grid grid-cols-1 gap-2">
                                <div class="flex items-center gap-2">
                                    <label class="text-xs text-gray-600 whitespace-nowrap">Chart:</label>
                                    <select id="chartType-${doc.id}" class="flex-1 px-2 py-2 bg-white text-gray-700 text-sm rounded border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent" title="Select chart type">
                                        <option value="auto">Auto</option>
                                        <option value="bar">Bar Chart</option>
                                        <option value="line">Line Chart</option>
                                        <option value="pie">Pie Chart</option>
                                        <option value="scatter">Scatter Plot</option>
                                        <option value="histogram">Histogram</option>
                                        <option value="box">Box Plot</option>
                                        <option value="heatmap">Heatmap</option>
                                    </select>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="visualizeDocument('${doc.id}', document.getElementById('chartType-${doc.id}').value)" class="flex-1 px-4 py-2 bg-purple-500 text-white text-sm font-medium rounded-md hover:bg-purple-600 focus:ring-2 focus:ring-purple-500 transition-all shadow-sm" title="Create visualizations">
                                        üìä Visualize
                                    </button>
                                    <button onclick="analyzeDocument('${doc.id}')" class="flex-1 px-4 py-2 bg-indigo-500 text-white text-sm font-medium rounded-md hover:bg-indigo-600 focus:ring-2 focus:ring-indigo-500 transition-all shadow-sm" title="Analyze document">
                                        üîç Analyze
                                    </button>
                                    <button onclick="deleteDocument('${doc.id}')" class="flex-1 px-4 py-2 bg-red-500 text-white text-sm font-medium rounded-md hover:bg-red-600 focus:ring-2 focus:ring-red-500 transition-all shadow-sm" title="Delete document">
                                        üóëÔ∏è Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

                console.log('üìù Setting innerHTML for', htmlContent.length, 'characters');
                listDiv.innerHTML = htmlContent;
                console.log('‚úÖ Documents displayed successfully');

                } catch (domError) {
                    console.error('‚ùå DOM manipulation error:', domError);
                    listDiv.innerHTML = '<p class="text-red-500 text-sm">Error updating display: ' + domError.message + '</p>';
                }

            } catch (error) {
                console.error('‚ùå Error loading documents:', error);
                const listDiv = document.getElementById('documentList');
                if (listDiv) {
                    listDiv.innerHTML = '<p class="text-red-500 text-sm">Error: ' + error.message + '</p>';
                } else {
                    console.error('‚ùå documentList element not found for error display');
                }
            }
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/v1/stats');
                const stats = await response.json();

                document.getElementById('docCount').textContent = stats.documents;
                document.getElementById('sessionCount').textContent = stats.chat_sessions;

            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function testUpload() {
            console.log('üß™ Creating test file for upload...');

            // Create a simple test file
            const testContent = 'This is a test document created for upload testing.\n\nIt contains some sample text to verify that the upload functionality is working correctly.\n\nIf you can see this message, the upload was successful!';
            const blob = new Blob([testContent], { type: 'text/plain' });
            const testFile = new File([blob], 'test_document.txt', { type: 'text/plain' });

            console.log('üìÑ Test file created:', testFile.name, testFile.size, 'bytes');

            // Directly upload the test file
            const files = [testFile];
            console.log('üéØ Uploading test file...');
            await uploadFiles(files);

            console.log('‚úÖ Test upload initiated');
        }

        async function uploadFiles(files) {
            console.log('üéØ uploadFiles triggered!');
            console.log('üìÅ Files to upload:', files);
            console.log('üìä Number of files:', files.length);

            if (files.length === 0) {
                console.log('No files to upload, returning');
                alert('No files to upload.');
                return;
            }

            const progressDiv = document.getElementById('uploadProgress');
            const resultsDiv = document.getElementById('uploadResults');

            console.log('Showing progress div');
            progressDiv.classList.remove('hidden');

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                console.log(`Processing file ${i + 1}/${files.length}:`, file.name, 'size:', file.size);

                const formData = new FormData();
                formData.append('file', file);

                try {
                    console.log('Sending upload request for:', file.name);

                    const response = await fetch('/api/v1/upload', {
                        method: 'POST',
                        body: formData
                    });

                    console.log('Response received, status:', response.status);

                    if (!response.ok) {
                        let errorText;
                        try {
                            errorText = await response.text();
                            console.error('Error response body:', errorText);
                        } catch (e) {
                            errorText = `HTTP ${response.status}: ${response.statusText}`;
                        }
                        console.error('Upload failed with status:', response.status);
                        showUploadResult({message: `Upload failed: ${response.status} ${response.statusText}\n${errorText}`}, false);
                        continue;
                    }

                    let result;
                    try {
                        result = await response.json();
                        console.log('Upload successful, result:', result);
                    } catch (e) {
                        console.error('Failed to parse JSON response');
                        const textResponse = await response.text();
                        console.log('Raw response text:', textResponse);
                        showUploadResult({message: 'Server returned invalid response format'}, false);
                        continue;
                    }

                    if (result && result.success) {
                        documents.push(result);
                        showUploadResult(result, true);
                        console.log('File uploaded successfully:', result.filename);
                        console.log('üîÑ Refreshing document list...');
                        // Refresh the document list to show the new document
                        await loadDocuments();
                        console.log('‚úÖ Document list refreshed');
                    } else {
                        console.error('Upload result indicates failure:', result);
                        showUploadResult(result || {message: 'Unknown upload error'}, false);
                    }
                } catch (error) {
                    console.error('Network error during upload:', error);
                    showUploadResult({message: `Network error: ${error.message}`}, false);
                }
            }

            progressDiv.classList.add('hidden');
            loadDocuments();
            loadStats();
        }

        async function startNewSession() {
            console.log('üÜï startNewSession function called');

            // Generate a new session ID
            sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            console.log('üÜî New session ID generated:', sessionId);

            // Clear chat messages
            const messagesDiv = document.getElementById('messages');
            console.log('üßπ Clearing chat messages');
            messagesDiv.innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    <p>üÜï New chat session started!</p>
                    <p class="mt-2">Ask questions about your uploaded documents.</p>
                </div>
            `;

            // Clear input
            document.getElementById('messageInput').value = '';
            console.log('üìù Input cleared');

            // Refresh sessions list
            console.log('üîÑ Refreshing sessions list...');
            await loadSessions();
            console.log('‚úÖ Sessions list refreshed');

            console.log('üÜï New session started:', sessionId);
            addResult('üÜï Started new chat session');
        }

        async function clearAllSessions() {
            console.log('üßπ clearAllSessions function called');

            if (!confirm('Clear all chat sessions? This will permanently delete all conversation history.')) {
                console.log('‚ùå User cancelled clear sessions operation');
                return;
            }

            try {
                const response = await fetch('/api/v1/chat/sessions', {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('üßπ Cleared sessions:', result);

                // Start new session
                await startNewSession();

                addResult(`üßπ Cleared ${result.sessions_cleared} chat sessions`);

            } catch (error) {
                console.error('‚ùå Error clearing sessions:', error);
                addResult(`‚ùå Error clearing sessions: ${error.message}`, false);
            }
        }

        async function refreshDocuments() {
            console.log('üîÑ refreshDocuments function called');

            const refreshBtn = document.getElementById('refreshBtn');
            const originalText = refreshBtn.textContent;
            refreshBtn.disabled = true;
            refreshBtn.textContent = 'üîÑ Refreshing...';
            console.log('üîÑ Button disabled and text changed to "Refreshing..."');

            try {
                console.log('üì° Calling loadDocuments()...');
                await loadDocuments();
                console.log('üì° Calling loadStats()...');
                await loadStats();
                console.log('‚úÖ Documents and stats refreshed successfully');
            } catch (error) {
                console.error('‚ùå Error refreshing:', error);
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.textContent = originalText;
                console.log('üîÑ Button re-enabled and text restored');
            }
        }

        async function deleteAllDocuments() {
            console.log('üóëÔ∏è deleteAllDocuments function called');

            if (!confirm('Are you sure you want to delete ALL documents? This action cannot be undone.')) {
                console.log('‚ùå User cancelled delete all operation');
                return;
            }

            console.log('‚úÖ User confirmed delete all operation');

            const deleteBtn = document.getElementById('deleteAllBtn');
            const originalText = deleteBtn.textContent;
            deleteBtn.disabled = true;
            deleteBtn.textContent = 'Deleting...';
            console.log('üîÑ Button disabled and text changed');

            try {
                addResult('Starting deletion of all documents...');

                // Use the bulk delete endpoint
                const deleteResponse = await fetch('/api/v1/documents', {
                    method: 'DELETE'
                });

                if (!deleteResponse.ok) {
                    const errorText = await deleteResponse.text();
                    throw new Error(`Delete failed: ${deleteResponse.status} ${errorText}`);
                }

                const result = await deleteResponse.json();
                addResult(`üéâ ${result.message}`);
                addResult(`‚úÖ Deleted ${result.deleted_count} documents`);
                addResult(`‚úÖ Vector database: ${result.vector_db_cleared ? 'Cleared' : 'Not cleared'}`);
                addResult(`‚úÖ Chat sessions: ${result.sessions_cleared || 0} cleared`);
                addResult(`‚úÖ All data reset - ready for fresh start!`);

                // Clear chat history and start fresh session
                sessionId = null;
                documents.length = 0; // Clear the documents array
                const messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <p>üóëÔ∏è All documents deleted successfully!</p>
                        <p class="mt-2">üÜï New session started automatically.</p>
                        <p class="mt-1">Upload new documents to start chatting.</p>
                    </div>
                `;

                // Clear any input
                document.getElementById('messageInput').value = '';

                console.log('üóëÔ∏è All documents deleted, session reset');

                // Refresh the UI
                loadDocuments();
                loadStats();

            } catch (error) {
                addResult(`‚ùå Error during deletion: ${error.message}`, false);
                console.error('Delete all error:', error);
            } finally {
                deleteBtn.disabled = false;
                deleteBtn.textContent = originalText;
            }
        }

        async function visualizeDocument(documentId, chartType = 'auto') {
            console.log('üìä Visualizing document:', documentId, 'chart type:', chartType);

            try {
                // Show loading state
                const messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="loading mx-auto mb-4"></div>
                        <p>Creating visualizations...</p>
                    </div>
                `;

                const response = await fetch('/api/v1/visualize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        document_id: documentId,
                        chart_type: chartType
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: response.statusText }));
                    throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('üìä Visualization result:', result);

                // Display the visualization
                const chartData = result.chart_data;
                const chartDiv = document.createElement('div');
                chartDiv.id = `chart-${documentId}`;
                chartDiv.style.width = '100%';
                chartDiv.style.height = '400px';

                messagesDiv.innerHTML = `
                    <div class="bg-white p-4 rounded-lg border">
                        <h3 class="text-lg font-semibold mb-2">üìä Data Visualization</h3>
                        <div class="mb-4">${chartDiv.outerHTML}</div>
                        <div class="text-sm text-gray-600">
                            <strong>Chart Type:</strong> ${result.chart_type}<br>
                            <strong>Insights:</strong>
                            <ul class="mt-1 ml-4 list-disc">
                                ${result.insights.map(insight => `<li>${insight}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                `;

                // Render the Plotly chart
                Plotly.newPlot(`chart-${documentId}`, chartData.data, chartData.layout);

                addResult('üìä Visualization created successfully');

            } catch (error) {
                console.error('‚ùå Visualization error:', error);
                const messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML = `
                    <div class="text-center text-red-500 py-8">
                        <p>‚ùå Error creating visualization</p>
                        <p class="mt-2 text-sm">${error.message}</p>
                    </div>
                `;
                addResult(`‚ùå Visualization failed: ${error.message}`, false);
            }
        }

        async function analyzeDocument(documentId) {
            console.log('üîç Analyzing document:', documentId);

            try {
                // Show loading state
                const messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="loading mx-auto mb-4"></div>
                        <p>Analyzing document...</p>
                    </div>
                `;

                const response = await fetch('/api/v1/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        document_id: documentId,
                        analysis_type: 'comprehensive'
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log('üîç Analysis result:', result);

                // Display the analysis
                messagesDiv.innerHTML = `
                    <div class="bg-white p-4 rounded-lg border">
                        <h3 class="text-lg font-semibold mb-3">üîç Document Analysis</h3>

                        <div class="mb-4">
                            <h4 class="font-medium text-gray-800 mb-2">Summary</h4>
                            <p class="text-sm text-gray-600">${result.summary}</p>
                        </div>

                        ${result.statistics && Object.keys(result.statistics).length > 0 ? `
                        <div class="mb-4">
                            <h4 class="font-medium text-gray-800 mb-2">Statistics</h4>
                            <div class="text-sm text-gray-600 space-y-1">
                                ${Object.entries(result.statistics).map(([key, value]) => {
                                    if (typeof value === 'object' && value !== null) {
                                        if (key.includes('_categories')) {
                                            return `<div><strong>${key.replace('_categories', '')}:</strong> ${value.unique_values} unique values</div>`;
                                        } else if (value.mean !== undefined) {
                                            return `<div><strong>${key}:</strong> avg ${value.mean.toFixed(1)}, range ${value.min}-${value.max}</div>`;
                                        } else {
                                            return `<div><strong>${key}:</strong> ${Object.keys(value).length} items</div>`;
                                        }
                                    } else {
                                        return `<div><strong>${key}:</strong> ${value}</div>`;
                                    }
                                }).join('')}
                            </div>
                        </div>
                        ` : ''}

                        ${result.insights && result.insights.length > 0 ? `
                        <div class="mb-4">
                            <h4 class="font-medium text-gray-800 mb-2">Key Insights</h4>
                            <ul class="text-sm text-gray-600 ml-4 list-disc">
                                ${result.insights.map(insight => `<li>${insight}</li>`).join('')}
                            </ul>
                        </div>
                        ` : ''}

                        ${result.recommendations && result.recommendations.length > 0 ? `
                        <div class="mb-4">
                            <h4 class="font-medium text-gray-800 mb-2">Recommendations</h4>
                            <ul class="text-sm text-gray-600 ml-4 list-disc">
                                ${result.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        </div>
                        ` : ''}
                    </div>
                `;

                addResult('üîç Analysis completed successfully');

            } catch (error) {
                console.error('‚ùå Analysis error:', error);
                const messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML = `
                    <div class="text-center text-red-500 py-8">
                        <p>‚ùå Error analyzing document</p>
                        <p class="mt-2 text-sm">${error.message}</p>
                    </div>
                `;
                addResult(`‚ùå Analysis failed: ${error.message}`, false);
            }
        }

        async function deleteSession(sessionId) {
            console.log('üóëÔ∏è deleteSession called for:', sessionId);

            if (!confirm('Are you sure you want to delete this chat session? This will permanently delete all conversation history for this session.')) {
                console.log('‚ùå User cancelled delete session operation');
                return;
            }

            console.log('‚úÖ User confirmed delete session operation');

            try {
                addResult('Deleting chat session...');

                const response = await fetch(`/api/v1/chat/history/${sessionId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Delete failed: ${response.status} ${errorText}`);
                }

                const result = await response.json();
                addResult(`‚úÖ ${result.message}`);
                addResult(`üóëÔ∏è Chat session deleted successfully`);

                // If deleting current session, start new one
                if (sessionId === sessionId) {
                    sessionId = null;
                    const messagesDiv = document.getElementById('messages');
                    messagesDiv.innerHTML = `
                        <div class="text-center text-gray-500 py-8">
                            <p>üóëÔ∏è Session deleted!</p>
                            <p class="mt-2">Start a fresh conversation.</p>
                        </div>
                    `;
                    document.getElementById('messageInput').value = '';
                }

                // Refresh sessions list
                loadSessions();
                loadStats();

            } catch (error) {
                addResult(`‚ùå Error deleting session: ${error.message}`, false);
                console.error('Delete session error:', error);
            }
        }

        async function deleteDocument(documentId) {
            console.log('üóëÔ∏è deleteDocument called for:', documentId);

            if (!confirm('Are you sure you want to delete this document? This action cannot be undone.')) {
                console.log('‚ùå User cancelled delete operation');
                return;
            }

            console.log('‚úÖ User confirmed delete operation');

            try {
                addResult('Deleting document...');

                const response = await fetch(`/api/v1/documents/${documentId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Delete failed: ${response.status} ${errorText}`);
                }

                const result = await response.json();
                addResult(`‚úÖ ${result.message}`);
                addResult(`üóëÔ∏è Document deleted successfully`);

                // Refresh the UI
                loadDocuments();
                loadStats();

            } catch (error) {
                addResult(`‚ùå Error deleting document: ${error.message}`, false);
                console.error('Delete document error:', error);
            }
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ DOMContentLoaded fired - Initializing application...');

            try {
                console.log('üìÑ Calling loadDocuments()...');
                loadDocuments().then(() => {
                    console.log('‚úÖ loadDocuments() completed');
                }).catch(error => {
                    console.error('‚ùå loadDocuments() failed:', error);
                });

                console.log('üìã Calling loadSessions()...');
                loadSessions().then(() => {
                    console.log('‚úÖ loadSessions() completed');
                }).catch(error => {
                    console.error('‚ùå loadSessions() failed:', error);
                });

                console.log('‚úÖ Initialization setup complete');
            } catch (error) {
                console.error('‚ùå Initialization error:', error);
            }
        });

        // Setup file input change listener
        const fileInput = document.getElementById('fileInput');
        console.log('üéß Setting up file input event listener for element:', fileInput);
        if (!fileInput) {
            console.error('‚ùå fileInput element not found!');
        } else {
            fileInput.addEventListener('change', async function(e) {
                console.log('üìÇ File input change event fired:', e);
                console.log('üìÇ Event target:', e.target);
                console.log('üìÇ Files selected:', e.target.files);
                const files = e.target.files;
                if (files && files.length > 0) {
                    const fileStatus = document.getElementById('fileStatus');
                    if (fileStatus) {
                        fileStatus.textContent = `${files.length} file(s) selected - ready to upload`;
                        fileStatus.classList.remove('hidden');
                    }
                    console.log('üìÇ Files selected, calling handleFileUpload');
                    try {
                        await handleFileUpload();
                        console.log('‚úÖ handleFileUpload completed');
                    } catch (error) {
                        console.error('‚ùå handleFileUpload failed:', error);
                    }
                } else {
                    console.log('üìÇ No files selected in change event');
                }
            });
        }

        // Setup drag and drop
        const dropZone = document.querySelector('label[for="fileInput"]');
        dropZone.addEventListener('click', function(e) {
            console.log('üè∑Ô∏è Upload zone clicked');
            // Let the default label behavior work
        });
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('bg-blue-50');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('bg-blue-50');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('bg-blue-50');
            const files = e.dataTransfer.files;
            document.getElementById('fileInput').files = files;
            handleFileUpload();
        });


    </script>
</body>
</html>